---
name: ci

# yamllint disable-line rule:truthy
on:
  pull_request:
    branches: [main, releases/v*]

  push:
    branches: [main, releases/v*]

jobs:
  ci:
    name: ${{ matrix.solution.name }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        solution:
        - name: Watchmin.Server
        - name: Watchmin.Client
        - name: Watchmin.Modules
          nuget: ${{ github.ref_name == 'main' || startsWith(github.ref_name, 'releases/v') }}

    steps:
    - name: Checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
      with:
        fetch-depth: 1
        fetch-tags: true

    - name: Dotnet setup
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Dotnet nuget source
      run: >-
        dotnet nuget add source
        --name "github"
        --username "BeeHiveJava"
        --password "${{ secrets.GITHUB_TOKEN }}"
        --store-password-in-clear-text
        "https://nuget.pkg.github.com/BeeHiveJava/index.json"
      working-directory: ${{ matrix.solution.name }}

    - name: Dotnet restore
      run: dotnet restore
      working-directory: ${{ matrix.solution.name }}

    - name: Dotnet build
      run: dotnet build --no-restore --configuration "Release"
      working-directory: ${{ matrix.solution.name }}

    - name: Dotnet test
      run: dotnet test --no-build --configuration "Release"
      working-directory: ${{ matrix.solution.name }}

    - name: Get commit sha
      run: |-
        if [ "${{ github.ref_name }}" != releases/v* ]; then
          echo "value=`echo ${{ github.sha }} | cut -c1-8`" >> "$GITHUB_OUTPUT"
        else
          echo "value=" >> "$GITHUB_OUTPUT"
        fi
      id: sha
      if: ${{ matrix.solution.nuget }}

    - name: Dotnet pack
      run: dotnet pack --no-build --configuration "Release" --version-suffix "pre.${{ steps.sha.outputs.value }}"
      working-directory: ${{ matrix.solution.name }}
      if: ${{ matrix.solution.nuget }}

    - name: Dotnet push
      run: >-
        dotnet nuget push
        --source "github"
        --api-key "${{ secrets.GITHUB_TOKEN }}"
        "**/*.nupkg"
      working-directory: ${{ matrix.solution.name }}
      if: ${{ matrix.solution.nuget }}
