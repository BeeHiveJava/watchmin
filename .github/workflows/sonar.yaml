---
name: sonar

# yamllint disable-line rule:truthy
on:
  pull_request:
    branches:
    - main

  push:
    branches:
    - main

jobs:
  sonar:
    name: ${{ matrix.solution.name }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        solution:
        - name: Watchmin.Server
          project: watchmin-server
        - name: Watchmin.Client
          project: watchmin-client
        - name: Watchmin.Modules
          project: watchmin-modules

    steps:
    - name: Checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
      with:
        fetch-depth: 0

    - name: Run sonar
      uses: highbyte/sonarscan-dotnet@v2.3.2
      with:
        sonarProjectKey: ${{ matrix.solution.project }}
        sonarProjectName: ${{ matrix.solution.project }}
        sonarOrganization: beehivejava
        dotnetBuildArguments: ${{ matrix.solution.name }}
        dotnetTestArguments: ${{ matrix.solution.name }} --logger trx --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        sonarBeginArguments: >-
          /d:sonar.cs.opencover.reportsPaths="**/TestResults/**/coverage.opencover.xml"
          /d:sonar.cs.vstest.reportsPaths="**/TestResults/*.trx"
          /d:sonar.exclusions="**/Examples/**"
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
